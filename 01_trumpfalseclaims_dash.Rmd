---
title: "Trump False Claims Data"
# resource_files:
# - .httr-oauth
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: cerulean
---

```{r setup, include=FALSE}

library(flexdashboard)
library(tidyverse)
library(lubridate)
library(janitor)
library(glue)
library(plotly)
library(DT)
library(googlesheets)
library(kableExtra)
library(leaflet)
# library(ggmap)
library(RColorBrewer)
library(htmlwidgets)
library(htmltools)
library(tigris)
options(tigris_class = "sf")
library(readxl)


raw_data <- read_excel("TRUMP FACT-CHECKS.xlsx", 
                                sheet = "ak", col_types = c("date", "text", 
                                                            "text", "text", "text", "text", "text", 
                                                            "text", "text", "text", "numeric", 
                                                            "text"))


glimpse(raw_data)

#clean column names
fcheck <- raw_data %>% 
  clean_names() 

names(fcheck)

#set formatting of certain columns and break out dates into own columns
fcheck <- fcheck %>% 
  mutate(
    kind_of_forum = str_trim(str_to_upper(kind_of_forum)),
    location = str_trim(str_to_upper(location)),
    category_tag1 = str_trim(str_to_upper(category_tag1)),
    category_tag2 = str_trim(str_to_upper(category_tag2)),
    category_tag3 = str_trim(str_to_upper(category_tag3)),
    category_tag4 = str_trim(str_to_upper(category_tag4)),
    year = year(date),
    month = month(date),
    day = day(date),
    week = week(date)
  )

fcheck <- fcheck %>% 
  mutate(
    kind_of_forum = as.factor(kind_of_forum),
    location = as.factor(location)
  )

# remove NAs from link column 
fcheck$source_article <- fcheck$source_article %>% replace_na("")

#convert link to html hyperlink format
fcheck$source_article <- paste0("<a href='", fcheck$source_article, "' target='_blank'>", fcheck$source_article, "</a>")

#create table of JUST THE PREVIOUS WEEK's checks
fcheck_PREVWEEK <- fcheck %>%
  filter(date <= today("EST"),
         date >= today("EST")-7)



# COUNTS #### ----------------------------------

#total count
count_total <- fcheck %>% 
  nrow()

#total count - previous week only
count_prevweek_total <- fcheck_PREVWEEK %>% 
  nrow()


#kind of forum count
count_forum_kind <- fcheck %>% 
  count(kind_of_forum) 

#kind of forum count - previous week only
count_prevweek_forum_kind <- fcheck_PREVWEEK %>% 
  count(kind_of_forum) 


#top kind of forum 
top_forum_kind <- fcheck %>% 
  count(kind_of_forum) %>% 
  arrange(desc(n)) %>% 
  head(1) %>% 
  select(kind_of_forum) %>% 
  pull() %>% 
  str_to_title()

#top kind of forum - previous week only
top_prevweek_forum_kind <- fcheck_PREVWEEK %>% 
  count(kind_of_forum) %>% 
  arrange(desc(n)) %>% 
  head(1) %>% 
  select(kind_of_forum) %>% 
  pull() %>% 
  str_to_title()


#top forum 
top_forum <- fcheck %>% 
  count(forum) %>% 
  arrange(desc(n)) %>% 
  head(1) %>% 
  select(forum) %>% 
  pull() %>% 
  str_to_title()

#top forum - previous week only
top_prevweek_forum <- fcheck_PREVWEEK %>% 
  count(forum) %>% 
  arrange(desc(n)) %>% 
  head(1) %>% 
  select(forum) %>% 
  pull() %>% 
  str_to_title()




# set time object set to eastern time
d <- Sys.Date()
# d <- .POSIXct(d, "EST")
  
t <- Sys.time()
t <- .POSIXct(t, "EST")

```


Searchable Database 
===================================== 
Trump false claim fact checks through `r format(d, format="%b %d")`. To filter the list, click on the boxes above the columns. To sort, click on the arrows by the column names. To search globally by keywords, use the search box on the right. 
(Last updated on `r format(t, format="%B %d %I:%M %p %Z")`)


Row 
-----------------------------------------------------------------------

### {data-width=800}

```{r searchable_table}

#searchable table

fcheck_table <- fcheck %>% 
  select(date,
         kind_of_forum,
         forum,
         location,
         claim,
         fact_check,
         source_article
)

datatable(fcheck_table, 
          rownames = FALSE, 
          filter = "top",
          escape = FALSE,
          options = list(searchHighlight = TRUE)) %>% 
  formatDate('date', 'toDateString') %>% 
  formatStyle('claim', fontStyle = 'italic')


```



Summary Counts (Previous Week) 
===================================== 
Aggregate counts of all Trump false claims made over the **previous seven days**. 


Row {data-height=200}
-----------------------------------------------------------------------

### Number of false claims

```{r count_total_box}

tot <- count_prevweek_total

valueBox(tot, icon = "fa-pencil", color = "lightblue")


```

### Top forum type

```{r}

valueBox(top_prevweek_forum_kind, icon = "fa-users", color = "#A8E9A8")


```

### Number of forums

```{r}

valueBox(top_prevweek_forum, icon = "fa-book", color = "#f4a8a7")



```



Row {data-height=800}
-----------------------------------------------------------------------


### Daily totals

```{r}

bydate <- fcheck_PREVWEEK %>%
  count(date) %>% 
  head() %>% 
  ungroup() 


d <- ggplot(data = bydate, aes(x = reorder(date, -n), y = n)) +
  geom_col(
    # color = "#848484",
    fill = "lightblue") +
  # coord_flip() +
  theme_minimal()

d2 <- d + labs(x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  # scale_fill_manual(values=cbPalette) +
  theme(legend.title=element_blank()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

dd <- ggplotly(d2)

dd_nomenu <- dd %>% config(displayModeBar = FALSE)
dd_nomenu

# ggplot(corr.m, aes(x = reorder(miRNA, -value), y = value, fill = variable)) +
#   geom_bar(stat = "identity")

```


### By forum type

```{r}

byforumtype <- fcheck_PREVWEEK %>%
  count(kind_of_forum) %>%
  arrange(desc(n)) %>%
  head() %>%
  ungroup()


e <- ggplot(data = byforumtype, aes(x = reorder(kind_of_forum, -n), y = n)) +
  geom_col(
    # color = "#848484",
    fill = "#A8E9A8") +
  # coord_flip() +
  theme_minimal()

e2 <- e + labs(x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  # scale_fill_manual(values=cbPalette) +
  theme(legend.title=element_blank()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ee <- ggplotly(e2)

ee_nomenu <- ee %>% config(displayModeBar = FALSE)
ee_nomenu


```


### By forum

```{r}

byforum <- fcheck_PREVWEEK %>% 
  count(forum) %>% 
  arrange(desc(n)) %>% 
  head()


e <- ggplot(data = byforum, aes(x = reorder(forum, -n), y = n)) +
  geom_col(
    # color = "#848484",
    fill = "#f4a8a7") +
  # coord_flip() +
  theme_minimal()

e2 <- e + labs(x ="", y = "") +
  theme(plot.title = element_text(hjust = 0.5)) +
  # scale_fill_manual(values=cbPalette) +
  theme(legend.title=element_blank()) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ee <- ggplotly(e2)

ee_nomenu <- ee %>% config(displayModeBar = FALSE)
ee_nomenu


```






